<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æ¥é§è»Šé ç´„ç³»çµ±</title>
<style>
:root{
    --orange:#ff7f2a;
    --bg:#fff6ef;
    --text:#333;
    --muted:#777;
    --card-shadow:0 2px 8px rgba(0,0,0,.1);
    --card-shadow-hover:0 6px 20px rgba(0,0,0,.2);
    --radius:15px;
}

body{
    font-family: Arial, sans-serif;
    background: var(--bg);
    margin:0;
    padding:20px;
    color:var(--text);
}

/* ====== steps ====== */
.step{
    display:none;
    margin-top:20px;
}
.active{
    display:block;
}

/* ====== groups ====== */
.button-group,
.card-group{
    display:flex;
    justify-content:center;
    flex-wrap:wrap;
    gap:20px;
}

/* ====== primary buttons ====== */
.btn-primary{
    background:var(--orange);
    color:#fff;
    border:none;
    border-radius:var(--radius);
    padding:16px 28px;
    font-size:18px;
    cursor:pointer;
    transition:transform .2s, box-shadow .2s;
    width: 240px;
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
}
.btn-primary:hover{
    transform:scale(1.05);
    box-shadow:0 4px 15px rgba(0,0,0,.2);
}

/* ====== normal buttons ====== */
.btn{
    background:#e9e9e9;
    color:#333;
    border:none;
    border-radius:var(--radius);
    padding:12px 20px;
    font-size:16px;
    cursor:pointer;
    transition:background .2s;
    min-width: 220px;
    text-align: center;
    box-sizing: border-box;
    margin: 5px 0;
    white-space: nowrap;
}
.btn:hover{
    background:#ddd;
}
.btn-orange{
    background:var(--orange);
    color:#fff;
}
.btn-orange:hover{
    filter:brightness(.95);
}

/* ====== cards ====== */
.card{
    background:#fff;
    box-shadow:var(--card-shadow);
    border-radius:var(--radius);
    padding:20px;
    width:240px;
    height:100px;
    cursor:pointer;
    transition:transform .2s, box-shadow .2s;
    color:var(--orange);
    white-space:pre-line;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
.card:hover{
    transform:scale(1.03);
    box-shadow:var(--card-shadow-hover);
}
.card h3{
    margin:0 0 8px;
    color:var(--orange);
    font-size:20px;
}
.card p{
    margin:6px 0 0;
    color:#666;
    font-weight:600;
}

/* ====== titles ====== */
.title-container {
    margin-bottom: 18px;
}
.title {
    font-size: 22px;
    color: #000;
    margin: 6px 0;
    font-weight: 600;
}
.subtitle {
    font-size: 18px;
    color: #000;
    margin: 6px 0;
    font-weight: normal;
}
.title-en {
    color: #000;
    font-size: 22px;
    font-weight: 600;
}
.subtitle-en {
    color: #000;
    font-size: 18px;
    font-weight: normal;
}

/* ====== responsive ====== */
@media (max-width: 768px) {
    .title-container { text-align: left; padding:0 10px; }
    .info-line { display:block; text-align:left; margin-bottom:8px; }
    .info-label { display:inline-block; min-width:100px; text-align:right; margin-right:5px; }
    .final-buttons { flex-direction: column; align-items: center; }
}
@media (min-width: 769px) {
    .title-container { text-align:center; }
    .info-line { text-align:center; }
}

/* ====== loading ====== */
#loading{
    position:fixed;
    inset:0;
    background:rgba(255,255,255,.94);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:9999;
    color:var(--orange);
    font-size:18px;
}
.loader{
    width:48px;
    height:48px;
    border-radius:50%;
    border:4px solid #f2f2f2;
    border-top:4px solid var(--orange);
    animation:spin 1s linear infinite;
    margin-bottom:10px;
}
@keyframes spin{
    to{ transform:rotate(360deg); }
}

/* ====== header block spacing ====== */
.header-block{ margin-bottom:8px; }
.final-buttons{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
}
.station-info{
    margin:10px 0;
    line-height:1.5;
}
</style>
</head>
<body>

<!-- Step 1: é¸æ–¹å‘ -->
<div id="step1" class="step">
    <div class="button-group">
        <button class="btn-primary" onclick="selectDirection('å»ç¨‹')">
            å»ç¨‹<br>Departure (From Hotel)
        </button>
        <button class="btn-primary" onclick="selectDirection('å›ç¨‹')">
            å›ç¨‹<br>Return (To Hotel)
        </button>
    </div>
</div>

<!-- Step 2: é¸æ—¥æœŸ -->
<div id="step2" class="step">
    <div class="title-container">
        <div id="step2Title" class="title"></div>
        <div class="subtitle" style="color: var(--muted);">
            *è«‹é¸æ“‡æ—¥æœŸ / Please select a date
        </div>
    </div>
    <div id="dateCards" class="card-group"></div>
    <div style="margin-top:16px; text-align:center;">
        <button class="btn" onclick="goBack(1)">â† è¿”å› / Back</button>
        <button class="btn" onclick="restart()">â†º é‡æ–°æŸ¥è©¢ / Restart</button>
    </div>
</div>

<!-- Step 3: é¸ç«™é» -->
<div id="step3" class="step">
    <div class="title-container">
        <div id="step3Title" class="title"></div>
        <div id="step3Sub" class="subtitle"></div>
    </div>
    <div id="stationCards" class="card-group"></div>
    <div style="margin-top:16px; text-align:center;">
        <button class="btn" onclick="goBack(2)">â† è¿”å› / Back</button>
        <button class="btn" onclick="restart()">â†º é‡æ–°æŸ¥è©¢ / Restart</button>
    </div>
</div>

<!-- Step 4: é¸ç­æ¬¡ -->
<div id="step4" class="step">
    <div class="title-container">
        <div id="finalTitleZh" class="title header-block"></div>
        <div id="finalMetaZh" class="subtitle header-block"></div>
        <div id="finalTitleEn" class="title title-en header-block"></div>
        <div id="finalMetaEn" class="subtitle subtitle-en header-block"></div>
    </div>
    <div id="scheduleCards" class="card-group" style="margin-top:10px;"></div>
    <div class="final-buttons">
        <button class="btn" onclick="goBack(3)">â† è¿”å› / Back</button>
        <button class="btn" onclick="restart()">â†º é‡æ–°æŸ¥è©¢ / Restart</button>
        <button class="btn btn-orange" onclick="bookNow()">ğŸ“ ç«‹å³é ç´„ / Book Now</button>
    </div>
</div>

<!-- Loading -->
<div id="loading">
    <div class="loader"></div>
    <div>è³‡æ–™è®€å–ä¸­ / Loading dataâ€¦</div>
</div>

<script>
/* ====== é…ç½® ====== */
const API_URL = "https://script.google.com/macros/s/AKfycbwSdpog6sJH9OerAUj9W7BesGHj4y2X9Jc0t1CBDM6iD9kzQYFn4iHc3mJUuO9q87Ke/exec";
const BOOK_URL = "https://docs.google.com/forms/d/e/1FAIpQLScVlCdt19OAsW-nEdd-eKhm5zs6cZGtTyVEJ-_ZcoV52lKoKg/viewform";

/* ====== ç‹€æ…‹ ====== */
let allRows = [];
let selectedDirection = "";
let selectedDateRaw = "";
let selectedDateLabel = "";
let selectedStationRaw = "";
let selectedStationZh = "";
let selectedStationEn = "";

/* ====== å·¥å…·å‡½æ•¸ ====== */
function fmtDateLabel(v){
    if(!v) return "";
    const s = String(v).trim();
    if(/^\d{4}-\d{2}-\d{2}T/.test(s)) return s.slice(0,10);
    if(/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(s)){
        const [y,m,d] = s.split("/");
        return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    }
    if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){
        const [m,d,y] = s.split("/");
        return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    }
    return s;
}

function fmtTimeLabel(v){
    if(v===null||v===undefined) return "";
    const s = String(v).trim();
    if(/^\d{4}-\d{2}-\d{2}T/.test(s)) return s.slice(11,16);
    const colon = s.replace("ï¼š", ":");
    if(/^\d{1,2}:\d{1,2}/.test(colon)){
        let [h,m] = colon.split(":");
        return `${String(h).padStart(2,"0")}:${String(m).slice(0,2).padStart(2,"0")}`;
    }
    const num = Number(s);
    if(!Number.isNaN(num) && num>=0 && num<2){
        const mins = Math.round((num%1)*24*60);
        const hh = String(Math.floor(mins/60)).padStart(2,"0");
        const mm = String(mins%60).padStart(2,"0");
        return `${hh}:${mm}`;
    }
    return s;
}

function splitStationZhEn(name){
    const s = (name||"").trim();
    const i = s.search(/[A-Za-z]/);
    if(i>0){
        return { zh:s.slice(0,i).trim(), en:s.slice(i).trim() };
    }
    return { zh:s, en:"" };
}

function stationWithBreak(name){
    const {zh,en} = splitStationZhEn(name);
    return en ? `${zh}\n${en}` : zh;
}

/* ====== UI ====== */
function showStep(n){
    document.querySelectorAll(".step").forEach(el=>el.classList.remove("active"));
    document.getElementById(`step${n}`).classList.add("active");
}

/* ====== è³‡æ–™è¼‰å…¥ ====== */
async function loadData(){
    const loading = document.getElementById("loading");
    loading.style.display = "flex";
    try{
        const res = await fetch(API_URL);
        const raw = await res.json();
        allRows = raw.filter(r=>r["å»ç¨‹ / å›ç¨‹"] && r["æ—¥æœŸ"] && r["ç­æ¬¡"] && r["ç«™é»"]);
        document.getElementById("step1").classList.add("active");
    }catch(e){
        alert("è³‡æ–™è®€å–ä¸­ / Loading data: " + e.message);
    }finally{
        loading.style.display="none";
    }
}

/* ====== æµç¨‹ ====== */
function selectDirection(dir){
    selectedDirection = dir;
    const dirEn = dir==="å›ç¨‹"?"Return (To Hotel)":"Departure (From Hotel)";
    document.getElementById("step2Title").textContent = `${dir} ${dirEn}`;
    const dateSet = new Set(
        allRows.filter(r=>String(r["å»ç¨‹ / å›ç¨‹"]).trim()===dir).map(r=>String(r["æ—¥æœŸ"]).trim())
    );
    const cards = document.getElementById("dateCards");
    cards.innerHTML="";
    [...dateSet].forEach(dateRaw=>{
        const card = document.createElement("div");
        card.className="card";
        card.innerHTML = `<h3>${fmtDateLabel(dateRaw)}</h3>`;
        card.onclick = ()=>selectDate(dateRaw);
        cards.appendChild(card);
    });
    showStep(2);
}

function selectDate(dateRaw){
    selectedDateRaw = String(dateRaw).trim();
    selectedDateLabel = fmtDateLabel(selectedDateRaw);
    document.getElementById("step3Title").textContent = `${selectedDirection} ${selectedDateLabel}`;
    const isReturn = selectedDirection==="å›ç¨‹";
    document.getElementById("step3Sub").innerHTML = isReturn?
        `<div class="station-info">ä¸‹è»Šç«™é» Drop-off: é£¯åº— / Hotel</div>
         <div class="station-info">ä¸Šè»Šç«™é» Boarding: <span style="color: var(--muted);">*è«‹é¸æ“‡ç«™é» / Please select</span></div>`:
        `<div class="station-info">ä¸Šè»Šç«™é» Boarding: é£¯åº— / Hotel</div>
         <div class="station-info">ä¸‹è»Šç«™é» Drop-off: <span style="color: var(--muted);">*è«‹é¸æ“‡ç«™é» / Please select</span></div>`;

    const stations = new Set(
        allRows.filter(r=>String(r["å»ç¨‹ / å›ç¨‹"]).trim()===selectedDirection && String(r["æ—¥æœŸ"]).trim()===selectedDateRaw)
               .map(r=>String(r["ç«™é»"]).trim())
    );
    const wrap = document.getElementById("stationCards");
    wrap.innerHTML="";
    [...stations].forEach(st=>{
        const card = document.createElement("div");
        card.className="card";
        card.innerHTML=`<h3>${stationWithBreak(st)}</h3>`;
        card.onclick=()=>selectStation(st);
        wrap.appendChild(card);
    });
    showStep(3);
}

function selectStation(stationRaw){
    selectedStationRaw = String(stationRaw).trim();
    const { zh,en } = splitStationZhEn(selectedStationRaw);
    selectedStationZh = zh;
    selectedStationEn = en;

    const zhDir = selectedDirection==="å›ç¨‹"?"å›ç¨‹":"å»ç¨‹";
    const enDir = selectedDirection==="å›ç¨‹"?"Return":"Departure";
    const zhBoard = selectedDirection==="å›ç¨‹"?`ä¸Šè»Šç«™é»: ${selectedStationZh||"ï¼ˆæœªæä¾›ï¼‰"}`:`ä¸Šè»Šç«™é»: é£¯åº—`;
    const zhDrop = selectedDirection==="å›ç¨‹"?`ä¸‹è»Šç«™é»: é£¯åº—`:`ä¸‹è»Šç«™é»: ${selectedStationZh||"ï¼ˆæœªæä¾›ï¼‰"}`;
    document.getElementById("finalTitleZh").textContent=`${zhDir} ${selectedDateLabel}`;
    document.getElementById("finalMetaZh").innerHTML=`${zhBoard}<br>${zhDrop}`;

    const enBoard = selectedDirection==="å›ç¨‹"?`Boarding: ${selectedStationEn||selectedStationZh||"N/A"}`:`Boarding: Hotel`;
    const enDrop = selectedDirection==="å›ç¨‹"?`Drop-off: Hotel`:`Drop-off: ${selectedStationEn||selectedStationZh||"N/A"}`;
    document.getElementById("finalTitleEn").textContent=`${enDir} ${selectedDateLabel}`;
    document.getElementById("finalMetaEn").innerHTML=`${enBoard}<br>${enDrop}`;

    const list = allRows.filter(r=>
        String(r["å»ç¨‹ / å›ç¨‹"]).trim()===selectedDirection &&
        String(r["æ—¥æœŸ"]).trim()===selectedDateRaw &&
        String(r["ç«™é»"]).trim()===selectedStationRaw
    );

    const wrap = document.getElementById("scheduleCards");
    wrap.innerHTML="";
    list.forEach(r=>{
        const timeLabel = fmtTimeLabel(r["ç­æ¬¡"]);
        const availText = String(r["å¯é ç´„äººæ•¸"]||r["å¯é ç´„ / Available"]||"").trim();
        const card = document.createElement("div");
        card.className="card";
        card.innerHTML=`<h3>${timeLabel}</h3><p>${availText}</p>`;
        wrap.appendChild(card);
    });

    showStep(4);
}

/* ====== æ§åˆ¶éˆ• ====== */
function goBack(step){ showStep(step); }
function restart(){
    // é‡ç½®é¸æ“‡ç‹€æ…‹
    selectedDirection="";
    selectedDateRaw="";
    selectedDateLabel="";
    selectedStationRaw="";
    selectedStationZh="";
    selectedStationEn="";
    allRows=[];

    // é¡¯ç¤º loading ç•«é¢
    document.getElementById("loading").style.display = "flex";

    // éš±è—æ‰€æœ‰æ­¥é©Ÿ
    document.querySelectorAll(".step").forEach(el=>el.classList.remove("active"));

    // é‡æ–°æŠ“å–è³‡æ–™
    loadData();
}
function bookNow(){ window.open(BOOK_URL,"_blank"); }

/* ====== å•Ÿå‹• ====== */
document.addEventListener("DOMContentLoaded", async ()=>{
    await loadData();
});
</script>
</body>
</html>



