<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>交通預約系統 / Shuttle Bus Reservation</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; text-align: center; }
  .hidden { display: none; }
  .card { border: 1px solid #ccc; border-radius: 10px; padding: 15px; margin: 10px; display: inline-block; cursor: pointer; width: 220px; }
  .card:hover { background: #f0f0f0; }
  .step { margin-top: 20px; }
  .station-name { white-space: pre-line; font-weight: bold; } /* 換行顯示中英文 */
  /* Loading 畫面 */
  #loadingScreen {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.95); display: flex; flex-direction: column;
    align-items: center; justify-content: center; z-index: 999;
    font-size: 18px;
  }
  .loader {
    border: 6px solid #f3f3f3; border-top: 6px solid #3498db;
    border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
    margin-bottom: 15px;
  }
  @keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<!-- Loading 畫面 -->
<div id="loadingScreen">
  <div class="loader"></div>
  <div>資料讀取中...<br>Loading data...</div>
</div>

<h1>交通預約系統 / Shuttle Bus Reservation</h1>

<div id="step1" class="step">
  <h2>選擇方向 / Select Direction</h2>
  <div id="directionCards">
    <div class="card" data-direction="去程">去程<br>Departure</div>
    <div class="card" data-direction="回程">回程<br>Return</div>
  </div>
</div>

<div id="step2" class="step hidden">
  <h2>選擇日期 / Select Date</h2>
  <div id="dateCards"></div>
</div>

<div id="step3" class="step hidden">
  <h2>選擇站別 / Select Station</h2>
  <div id="stationCards"></div>
</div>

<div id="step4" class="step hidden">
  <h2>選擇班次 / Select Time</h2>
  <div id="timeCards"></div>
</div>

<script>
let allData = [];
let selectedDirection = '';
let selectedDate = '';
let selectedStation = '';

async function fetchData() {
  const sheetUrl = 'https://script.google.com/macros/s/AKfycbwSdpog6sJH9OerAUj9W7BesGHj4y2X9Jc0t1CBDM6iD9kzQYFn4iHc3mJUuO9q87Ke/exec';
  
  const response = await fetch(sheetUrl);
  if (!response.ok) {
    throw new Error(`HTTP error! Status: ${response.status}`);
  }
  
  const data = await response.json();

  // 自動處理站名換行
  data.forEach(r => {
    if (r["站點"] && r["站點"].includes(' ')) {
      const parts = r["站點"].split(' ');
      r["站點"] = parts[0] + '\n' + parts.slice(1).join(' ');
    }
  });

  return data;
}

function showStep(stepNum) {
  document.querySelectorAll('.step').forEach(step => step.classList.add('hidden'));
  document.getElementById(`step${stepNum}`).classList.remove('hidden');
}

function loadDates() {
  const dates = [...new Set(allData
    .filter(r => r["去程 / 回程"].trim() === selectedDirection)
    .map(r => r["日期"])
  )];

  const container = document.getElementById('dateCards');
  container.innerHTML = '';
  dates.forEach(date => {
    const card = document.createElement('div');
    card.className = 'card';
    card.textContent = date;
    card.addEventListener('click', () => {
      selectedDate = date;
      loadStations();
      showStep(3);
    });
    container.appendChild(card);
  });
}

function loadStations() {
  const stations = [...new Set(allData
    .filter(r => r["去程 / 回程"].trim() === selectedDirection && r["日期"] === selectedDate)
    .map(r => r["站點"])
  )];

  const container = document.getElementById('stationCards');
  container.innerHTML = '';
  stations.forEach(station => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `<div class="station-name">${station}</div>`;
    card.addEventListener('click', () => {
      selectedStation = station;
      loadTimes();
      showStep(4);
    });
    container.appendChild(card);
  });
}

function loadTimes() {
  const times = allData
    .filter(r =>
      r["去程 / 回程"].trim() === selectedDirection &&
      r["日期"] === selectedDate &&
      r["站點"] === selectedStation
    );

  const container = document.getElementById('timeCards');
  container.innerHTML = '';
  times.forEach(time => {
    const card = document.createElement('div');
    card.className = 'card';
    card.textContent = `${time["班次"]} (${time["可預約人數"]})`;
    container.appendChild(card);
  });
}

// 初始化流程
document.addEventListener('DOMContentLoaded', async () => {
  try {
    allData = await fetchData();
  } catch (err) {
    alert("資料載入失敗 / Failed to load data: " + err.message);
    return;
  }

  // 關閉 Loading 畫面
  document.getElementById('loadingScreen').style.display = 'none';

  document.querySelectorAll('#directionCards .card').forEach(card => {
    card.addEventListener('click', () => {
      selectedDirection = card.dataset.direction;
      loadDates();
      showStep(2);
    });
  });
});
</script>

</body>
</html>
